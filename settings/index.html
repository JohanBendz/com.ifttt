<!doctype html>
<html>
<head>
	<script type="text/javascript" src="/manager/webserver/assets/js/jquery.js"></script>
	<link rel="stylesheet" href="/manager/webserver/assets/css/font.awesome.css">

	<script type="text/javascript">
		let authorizationUrl = '';

		// TODO this can be removed once Homey.popup() is available in settings
		function popup(url, options) {
			$('#auth_button').prop('disabled', true);
			$('#error_message').hide();
			$('#auth_icon').prop('class', 'fa fa-cog fa-spin');

			options = $.extend({
				width: 400,
				height: 400
			}, options)

			var left = (screen.width / 2) - (options.width / 2);
			var top = (screen.height / 2) - (options.height / 2);

			return window.open(url, "homey_dialog", "width=" + options.width + ", height=" + options.height + ", left=" + left + ", top=" + top + ", menubar=no, status=no, toolbar=no");
		}

		function onHomeyReady() {

			Homey.ready();

			$('#introText').hide();
			$('#revertIntroText').hide();

			// Hide all div containers with buttons
			$('#auth').hide();
			$('#revoke').hide();

			// Disable all buttons
			$('#auth_button').prop('disabled', true);
			$('#revoke_button').prop('disabled', true);

			// Hide error message
			$('#error_message').hide();

			// Append auth icon to auth_button
			$('#auth_button').append('<span id="auth_icon" class="fa fa-check" style="margin-left:5px"></span>');
			$('#revoke_button').append('<span id="revoke_icon" class="fa fa-check" style="margin-left:5px"></span>');

			// Get access token to see if authorized
			Homey.get('ifttt_access_token', function (err, token) {
				if (!token || err) {

					console.log('No access token found');

					// Show auth button
					showAuthButton();

					// Get authorization url
					Homey.api('GET', '/authorizationUrl/', function (err, url) {
						if (err) {
							$('#auth_button').prop('disabled', true);
							return console.error(err);
						}

						console.log("Got new authorization url");

						authorizationUrl = url;

						$('#auth_button').prop('disabled', false);
					});
				} else {
					console.log('Access token found');

					// Show revoke button
					showRevokeButton();
				}
			});

			Homey.on('authorized', function (success) {
				if (success) {
					// Show revoke button
					showRevokeButton();

					// Display error
					$('#error_message').hide();
					$('#auth_icon').prop('class', '');

				} else {

					// Get authorization url
					Homey.api('GET', '/authorizationUrl/', function (err, url) {
						if (err) return console.error(err);

						console.log("Got new authorization url");

						authorizationUrl = url;

						// Show auth button
						showAuthButton();

						// Display error
						$('#auth_icon').prop('class', 'fa fa-exclamation-triangle');
						$('#auth_button').prop('disabled', false);
						$('#error_message').show();
					});
				}
			});
		}

		function showRevokeButton() {
			$('#introText').hide();
			$('#revertIntroText').show();

			$('#auth').hide();
			$('#revoke').show();
			$('#revoke_button').prop('disabled', false);
			$('#auth_button').prop('disabled', true);
			$('#revoke_icon').prop('class', '');
		}

		function showAuthButton() {
			$('#introText').show();
			$('#revertIntroText').hide();

			$('#auth').show();
			$('#revoke').hide();
			$('#revoke_button').prop('disabled', true);
			$('#auth_button').prop('disabled', false);
			$('#auth_icon').prop('class', '');
		}

		function revokeAccessToken() {

			// Disable button while processing
			$('#revoke_button').prop('disabled', true);
			$('#revoke_icon').prop('class', 'fa fa-cog fa-spin');

			// Post revoke auth to remove access tokens
			Homey.api('POST', 'revokeAuthorization', function (err, success) {
				if (!err && success) {

					console.log('revoked authorization');

					// Get authorization url
					Homey.api('GET', '/authorizationUrl/', function (err, url) {
						if (err) return console.error(err);

						console.log("Got new authorization url");

						authorizationUrl = url;

						setTimeout(function () {

							// Show auth button
							showAuthButton();

							// Disable all buttons
							$('#revoke_button').prop('disabled', false);
							$('#auth_button').prop('disabled', false);
						}, 1000);
					});
				}
			});
		}

	</script>
</head>
<body>
<h1 data-i18n="settings.title"></h1>
<p id="introText" data-i18n="settings.intro"></p>
<p id="revertIntroText" data-i18n="settings.revert_intro"></p>
<div id="revoke">
	<button id='revoke_button' class="left" onclick="revokeAccessToken()" data-i18n="settings.revoke"></button>
</div>
<div id="auth">
	<button id='auth_button' class="left" onclick="popup(authorizationUrl)" data-i18n="settings.authorize"></button>
	<p id="error_message" data-i18n="settings.authorize_error" style="float: left; margin-left: 8px; height: 28px;line-height:28px; color: red;"></p>
</div>
</body>
</html>